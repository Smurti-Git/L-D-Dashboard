<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Enterprise Cloud Analytical Hub - Final Stable</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/interact.js/1.10.11/interact.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root { --primary: #1e293b; --accent: #2563eb; --bg: #f1f5f9; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; flex-direction: column; }
        .main-wrapper { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 380px; background: white; border-right: 1px solid #e2e8f0; padding: 20px; display: flex; flex-direction: column; z-index: 1000; box-shadow: 2px 0 10px rgba(0,0,0,0.05); overflow-y: auto; }
        
        .auth-card { background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .share-box { background: #f0fdf4; border: 1px solid #bbf7d0; padding: 10px; border-radius: 8px; margin: 10px 0; }

        .tab-bar { background: #1e293b; display: flex; padding: 0 10px; align-items: center; height: 40px; gap: 2px; }
        .tab { padding: 8px 20px; color: #94a3b8; cursor: pointer; font-size: 12px; border-radius: 6px 6px 0 0; background: #334155; transition: 0.2s; border: none; margin-top: 5px; display: flex; align-items: center; gap: 8px; position: relative; }
        .tab.active { background: #f1f5f9; color: #1e293b; font-weight: bold; }
        .tab-close { color: #ef4444; font-weight: bold; font-size: 14px; cursor: pointer; opacity: 0.5; }
        .tab-close:hover { opacity: 1; }

        .canvas-container { flex: 1; position: relative; overflow: auto; background-color: #cbd5e1; }
        .canvas-area { position: absolute; min-width: 5000px; min-height: 5000px; background-image: radial-gradient(#94a3b8 1px, transparent 1px); background-size: 30px 30px; transform-origin: 0 0; display: none; }
        .canvas-area.active { display: block; }

        input, select { padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; width: 94%; margin-bottom: 8px; font-size: 13px; }
        .btn { cursor: pointer; border: none; padding: 10px; border-radius: 4px; font-weight: 600; font-size: 12px; width: 100%; color: white; margin-bottom: 5px; }
        .btn-primary { background: var(--accent); } .btn-success { background: #10b981; } .btn-danger { background: #ef4444; } .btn-reset { background: #64748b; }

        .chart-widget { position: absolute; background: white; border-radius: 12px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); padding: 15px; min-width: 480px; display: flex; flex-direction: column; z-index: 10; overflow: hidden; }
        .widget-header { cursor: move; padding-bottom: 8px; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-between; font-weight: bold; font-size: 13px; align-items: center;}
        .widget-title { cursor: pointer; padding: 2px 5px; border-radius: 4px; }
        .widget-title:hover { background: #f1f5f9; }
        .widget-content { flex: 1; overflow-y: auto; margin-top: 10px; }
        
        .kpi-value { font-size: 42px; font-weight: 800; text-align: center; margin: 15px 0; color: var(--primary); }
        .kpi-label { text-align: center; font-size: 12px; color: #64748b; text-transform: uppercase; }
        .w-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 15px; background: white; }
        .w-table th, .w-table td { padding: 8px; border: 1px solid #e2e8f0; text-align: left; }
        .w-table th { background: #f8fafc; position: sticky; top: 0; }
        .builder-row { display: flex; gap: 5px; align-items: center; background: #f8fafc; padding: 8px; border-radius: 4px; margin-bottom: 5px; border: 1px solid #e2e8f0; }
        .builder-row select { margin-bottom: 0; flex: 1; }
    </style>
</head>
<body>

<div class="main-wrapper">
    <div class="sidebar">
        <div class="auth-card">
            <div id="logged-out-ui">
                <button class="btn btn-primary" onclick="login()">Login with Google</button>
            </div>
            <div id="logged-in-ui" style="display:none">
                <p style="font-size:11px; margin-bottom:5px;">User: <b id="user-email"></b></p>
                <button class="btn btn-danger" style="padding:4px; font-size:10px;" onclick="logout()">Logout</button>
            </div>
        </div>

        <div id="share-panel" class="share-box" style="display:none">
            <label style="font-size:11px; font-weight:bold;">SHARE TAB WITH TEAM:</label>
            <div style="display:flex; gap:5px; margin-top:5px;">
                <input type="email" id="shareEmail" placeholder="email@gmail.com" style="margin-bottom:0; width: 60%;">
                <button class="btn btn-success" style="width:auto; margin-bottom:0;" onclick="shareTab()">Share</button>
            </div>
        </div>

        <h3>1. System Controls</h3>
        <input type="text" id="sheetUrl" placeholder="Google Sheet URL">
        <button class="btn btn-primary" onclick="importSheet()">+ Add Tab Data</button>
        <button class="btn btn-success" onclick="location.reload()">ðŸ”„ Global Sync (Live Refresh)</button>
        
        <div style="background:#f1f5f9; padding:10px; border-radius:8px; margin:10px 0;">
            <label style="font-size:11px; font-weight:bold;">CANVAS ZOOM:</label>
            <input type="range" min="0.3" max="1.5" step="0.1" value="1" oninput="setZoom(this.value)">

            <label style="font-size:11px; font-weight:bold; margin-top:10px; display:block;">GLOBAL DATE FILTER:</label>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                <select id="fM" onchange="triggerUpdate()"></select><select id="fY" onchange="triggerUpdate()"></select>
                <select id="tM" onchange="triggerUpdate()"></select><select id="tY" onchange="triggerUpdate()"></select>
            </div>
        </div>

        <hr>
        <h3>2. Widget Designer</h3>
        <select id="chartType">
            <optgroup label="Visualizations">
                <option value="bar">Bar Chart + Table</option>
                <option value="horizontalBar">Horizontal Bar</option>
                <option value="pie">Pie Chart</option>
                <option value="line">Line Chart</option>
            </optgroup>
            <optgroup label="Data View">
                <option value="kpi">KPI Card (Summary)</option>
                <option value="tableOnly">Table Only</option>
            </optgroup>
        </select>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
            <div><label style="font-size:10px">Chart Color</label><input type="color" id="cColor" value="#2563eb"></div>
            <div><label style="font-size:10px">Widget BG</label><input type="color" id="bgColor" value="#ffffff"></div>
        </div>
        <div id="logicPanel"></div>
        <button class="btn btn-reset" onclick="addMetric()">+ Add Metric Row</button>
        <button class="btn btn-primary" onclick="saveWidget()">ðŸ’¾ Deploy Widget</button>
    </div>

    <div class="canvas-container" id="canvasContainer"></div>
</div>

<div class="tab-bar" id="tabBar">
    <button class="add-tab-btn" onclick="addNewCanvas()" id="add-btn">+ New Tab</button>
</div>

<script>
    // --- FIREBASE INITIALIZATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyCgeFuvK0YNFSWqHLURU_JeyZ_0tINhpBc",
        authDomain: "enterprise-analytical-hub.firebaseapp.com",
        databaseURL: "https://enterprise-analytical-hub-default-rtdb.firebaseio.com",
        projectId: "enterprise-analytical-hub",
        storageBucket: "enterprise-analytical-hub.firebasestorage.app",
        messagingSenderId: "653682211991",
        appId: "1:653682211991:web:ab56f6d143d8e615127dd2"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    let currentUser = null, activeCanvasId = null, currentZoom = 1;
    let rawStore = {}, activeWidgets = [], canvasTabs = [];

    const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    const years = [2023, 2024, 2025, 2026, 2027];

    // --- AUTHENTICATION & CLOUD SYNC ---
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            document.getElementById('logged-in-ui').style.display = 'block';
            document.getElementById('logged-out-ui').style.display = 'none';
            document.getElementById('share-panel').style.display = 'block';
            document.getElementById('user-email').innerText = user.email;
            startCloudSync();
        } else {
            currentUser = null;
            document.getElementById('logged-in-ui').style.display = 'none';
            document.getElementById('logged-out-ui').style.display = 'block';
        }
    });

    function login() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
    function logout() { auth.signOut().then(() => location.reload()); }

    function startCloudSync() {
        const myEmail = currentUser.email.toLowerCase();
        db.ref('tabs').on('value', snapshot => {
            const data = snapshot.val() || {};
            canvasTabs = []; activeWidgets = [];
            Object.keys(data).forEach(id => {
                const tab = data[id];
                const shared = tab.sharedWith || [];
                if (tab.owner === myEmail || shared.includes(myEmail)) {
                    canvasTabs.push(tab.config);
                    if (tab.widgets) Object.values(tab.widgets).forEach(w => activeWidgets.push(w));
                }
            });
            if (!activeCanvasId && canvasTabs.length > 0) activeCanvasId = canvasTabs[0].id;
            renderTabs();
            autoLoadSources(); // CRITICAL: This re-fetches sheet data on refresh
        });
        setupFilters();
    }

    function saveToCloud() {
        if (!currentUser || !activeCanvasId) return;
        const tab = canvasTabs.find(t => t.id === activeCanvasId);
        if (!tab || tab.owner !== currentUser.email) return;

        const widgets = activeWidgets.filter(w => w.canvasId === activeCanvasId);
        db.ref(`tabs/${activeCanvasId}`).update({
            config: tab,
            owner: currentUser.email,
            widgets: widgets
        });
    }

    // --- DATA FETCHING & PERSISTENCE ---
    async function fetchData(id, tabName, url, saveToDb = true) {
        const csvUrl = `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(tabName)}`;
        try {
            const r = await fetch(csvUrl);
            const txt = await r.text();
            Papa.parse(txt, { header: true, complete: (res) => {
                rawStore[tabName] = { data: res.data, headers: Object.keys(res.data[0]), url, id };
                
                // Save the source metadata so it survives refreshes
                if(saveToDb && activeCanvasId) {
                    const idx = canvasTabs.findIndex(t => t.id === activeCanvasId);
                    if(!canvasTabs[idx].sources) canvasTabs[idx].sources = [];
                    if(!canvasTabs[idx].sources.find(s => s.tabName === tabName)) {
                        canvasTabs[idx].sources.push({ id, tabName, url });
                        saveToCloud();
                    }
                }
                triggerUpdate();
                if(document.querySelectorAll('.builder-row').length === 0) addMetric();
            }});
        } catch(e) { console.error("Sheet Fetch Error", e); }
    }

    function autoLoadSources() {
        const currentTab = canvasTabs.find(t => t.id === activeCanvasId);
        if (currentTab && currentTab.sources) {
            currentTab.sources.forEach(src => {
                if (!rawStore[src.tabName]) fetchData(src.id, src.tabName, src.url, false);
            });
        }
    }

    async function importSheet() {
        const url = document.getElementById('sheetUrl').value;
        const idMatch = url.match(/\/d\/(.+?)\//);
        const tab = prompt("Tab Name?");
        if(idMatch && tab) await fetchData(idMatch[1], tab, url);
    }

    // --- UI RENDERING & CORE LOGIC ---
    function renderTabs() {
        const container = document.getElementById('tabBar');
        container.querySelectorAll('.tab').forEach(t => t.remove());
        canvasTabs.forEach(tab => {
            const btn = document.createElement('button');
            btn.className = `tab ${tab.id === activeCanvasId ? 'active' : ''}`;
            btn.innerHTML = `<span>${tab.name}</span> <span class="tab-close" onclick="deleteTab('${tab.id}', event)">Ã—</span>`;
            btn.onclick = () => { activeCanvasId = tab.id; renderTabs(); };
            btn.ondblclick = () => renameTab(tab.id);
            container.insertBefore(btn, document.getElementById('add-btn'));
        });
        const canvasContainer = document.getElementById('canvasContainer');
        canvasContainer.innerHTML = '';
        canvasTabs.forEach(tab => {
            const div = document.createElement('div');
            div.className = `canvas-area ${tab.id === activeCanvasId ? 'active' : ''}`;
            div.id = `canvas-${tab.id}`;
            canvasContainer.appendChild(div);
        });
        activeWidgets.forEach(w => renderWidgetUI(w));
    }

    function renderWidgetUI(config) {
        if(config.canvasId !== activeCanvasId) return;
        const canvas = document.getElementById(`canvas-${activeCanvasId}`);
        const widget = document.createElement('div');
        widget.className = 'chart-widget';
        widget.id = `wid-${config.id}`;
        widget.style.backgroundColor = config.bgColor || '#ffffff';
        widget.style.transform = `translate(${config.pos.x}px, ${config.pos.y}px)`;
        widget.style.width = (config.pos.w || 550) + 'px';
        widget.style.height = (config.pos.h || 450) + 'px';
        
        widget.innerHTML = `
            <div class="widget-header">
                <span class="widget-title" onclick="renameWidget(${config.id})">${config.customName || config.metrics[1]?.col || 'Widget'}</span> 
                <button onclick="removeWidget(${config.id})" style="border:none;background:none;color:red;cursor:pointer;font-weight:bold;">âœ•</button>
            </div>
            <div class="widget-content" id="cont-${config.id}"></div>`;
        canvas.appendChild(widget);
        updateWidget(config);
        makeInteractive(widget, config);
    }

    function updateWidget(config) {
        const container = document.getElementById(`cont-${config.id}`);
        if(!container || !config.metrics[0] || !rawStore[config.metrics[0].tab]) {
            container.innerHTML = `<p style="font-size:10px; color:#94a3b8">Loading Data: ${config.metrics[0]?.tab || '...'}</p>`;
            return;
        }

        const fM = parseInt(document.getElementById('fM').value), fY = years[document.getElementById('fY').value];
        const tM = parseInt(document.getElementById('tM').value), tY = years[document.getElementById('tY').value];
        const mainTab = config.metrics[0].tab;
        const data = rawStore[mainTab].data;
        const dateCol = rawStore[mainTab].headers.find(h => h.toLowerCase().includes('date') || h.toLowerCase().includes('month'));

        let summary = {}, gTotal = 0, gCount = 0;
        data.forEach(item => {
            if(dateCol && item[dateCol]) {
                const d = new Date(item[dateCol]);
                const m = d.getMonth(), y = d.getFullYear();
                if(y < fY || y > tY || (y==fY && m < fM) || (y==tY && m > tM)) return;
            }
            const key = item[config.metrics[0].col] || "Other";
            if(!summary[key]) summary[key] = { val: 0, count: 0 };
            
            const raw = item[config.metrics[1]?.col]?.toString().replace(/[^\d.-]/g, '');
            const val = parseFloat(raw);
            if(!isNaN(val)) {
                summary[key].val += val;
                summary[key].count++;
                gTotal += val; gCount++;
            }
        });

        if(config.type === 'kpi') {
            const op = config.metrics[1]?.op || 'sum';
            let res = op === 'avg' ? (gTotal/gCount).toFixed(2) : (op === 'count' ? gCount : gTotal.toLocaleString());
            container.innerHTML = `<div class="kpi-value" style="color:${config.cColor}">${res}</div><div class="kpi-label">${config.metrics[1]?.col || ''}</div>`;
        } else {
            const labels = Object.keys(summary);
            const chartData = labels.map(l => config.metrics[1]?.op === 'avg' ? (summary[l].val/summary[l].count) : summary[l].val);
            
            if(config.type !== 'tableOnly') {
                container.innerHTML = `<div style="height:220px"><canvas id="c-${config.id}"></canvas></div><div id="t-${config.id}"></div>`;
                new Chart(document.getElementById(`c-${config.id}`), {
                    type: config.type === 'horizontalBar' ? 'bar' : config.type,
                    data: { labels, datasets: [{ data: chartData, backgroundColor: config.cColor }] },
                    options: { indexAxis: config.type === 'horizontalBar' ? 'y' : 'x', maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            } else {
                container.innerHTML = `<div id="t-${config.id}"></div>`;
            }

            let table = `<table class="w-table"><thead><tr><th>${config.metrics[0].col}</th><th>Value (${config.metrics[1]?.op})</th></tr></thead><tbody>`;
            labels.forEach(l => table += `<tr><td>${l}</td><td>${summary[l].val.toLocaleString()}</td></tr>`);
            document.getElementById(`t-${config.id}`).innerHTML = table + `</tbody></table>`;
        }
    }

    // --- UTILITIES ---
    function addNewCanvas() {
        if(!currentUser) return alert("Please Login First");
        const id = 'tab-' + Date.now();
        canvasTabs.push({ id, name: 'Cloud Dashboard ' + (canvasTabs.length+1), owner: currentUser.email, sources: [] });
        activeCanvasId = id;
        saveToCloud();
    }

    function deleteTab(id, e) {
        e.stopPropagation();
        if(confirm("Permanently delete this tab from cloud?")) {
            db.ref(`tabs/${id}`).remove();
        }
    }

    function renameTab(id) {
        const n = prompt("New Tab Name?");
        if(n) { canvasTabs.find(t => t.id === id).name = n; renderTabs(); saveToCloud(); }
    }

    function renameWidget(id) {
        const n = prompt("New Widget Name?");
        if(n) { 
            const w = activeWidgets.find(x => x.id === id);
            w.customName = n;
            saveToCloud();
        }
    }

    function addMetric() {
        const div = document.createElement('div');
        div.className = "builder-row";
        let tabs = Object.keys(rawStore).map(t => `<option value="${t}">${t}</option>`).join('');
        div.innerHTML = `
            <select class="t-s" onchange="loadCols(this)"><option>Tab</option>${tabs}</select>
            <select class="c-s"><option>Col</option></select>
            <select class="m-s"><option value="sum">Sum</option><option value="avg">Avg</option><option value="count">Count</option></select>
            <button onclick="this.parentElement.remove()" style="border:none; background:none; color:red; cursor:pointer">âœ•</button>`;
        document.getElementById('logicPanel').appendChild(div);
    }

    function loadCols(el) { 
        if(rawStore[el.value]) el.parentElement.querySelector('.c-s').innerHTML = rawStore[el.value].headers.map(h => `<option value="${h}">${h}</option>`).join(''); 
    }

    function saveWidget() {
        const rows = Array.from(document.querySelectorAll('.builder-row'));
        if(rows.length < 2) return alert("Add at least 2 metric rows (Label + Data)");
        const config = {
            id: Date.now(), canvasId: activeCanvasId,
            type: document.getElementById('chartType').value,
            cColor: document.getElementById('cColor').value,
            bgColor: document.getElementById('bgColor').value,
            metrics: rows.map(r => ({ tab: r.querySelector('.t-s').value, col: r.querySelector('.c-s').value, op: r.querySelector('.m-s').value })),
            pos: { x: 50, y: 50, w: 550, h: 450 }
        };
        activeWidgets.push(config);
        saveToCloud();
    }

    function removeWidget(id) {
        activeWidgets = activeWidgets.filter(w => w.id !== id);
        const el = document.getElementById(`wid-${id}`);
        if(el) el.remove();
        saveToCloud();
    }

    function shareTab() {
        const email = document.getElementById('shareEmail').value.toLowerCase().trim();
        if(!email || !activeCanvasId) return alert("Enter email and ensure tab is active");
        db.ref(`tabs/${activeCanvasId}/sharedWith`).once('value', s => {
            let list = s.val() || [];
            if(!list.includes(email)) {
                list.push(email);
                db.ref(`tabs/${activeCanvasId}/sharedWith`).set(list).then(() => alert("Shared Successfully!"));
            }
        });
    }

    function makeInteractive(el, config) {
        interact(el).draggable({ allowFrom: '.widget-header', onmove: (e) => {
            config.pos.x += e.dx / currentZoom; config.pos.y += e.dy / currentZoom;
            el.style.transform = `translate(${config.pos.x}px, ${config.pos.y}px)`;
            saveToCloud();
        }}).resizable({ edges: { right: true, bottom: true }, onmove: (e) => {
            config.pos.w = e.rect.width / currentZoom; config.pos.h = e.rect.height / currentZoom;
            Object.assign(el.style, { width: config.pos.w + 'px', height: config.pos.h + 'px' });
            saveToCloud();
        }});
    }

    function setupFilters() {
        const populate = (id, arr, sel) => {
            const el = document.getElementById(id);
            el.innerHTML = "";
            arr.forEach((v, i) => el.innerHTML += `<option value="${i}" ${i==sel?'selected':''}>${v}</option>`);
        };
        populate('fM', months, 0); populate('tM', months, 11);
        populate('fY', years, 2); populate('tY', years, 4);
    }

    function setZoom(v) { currentZoom = v; document.querySelectorAll('.canvas-area').forEach(c => c.style.transform = `scale(${v})`); }
    function triggerUpdate() { activeWidgets.forEach(w => updateWidget(w)); }
</script>
</body>
</html>